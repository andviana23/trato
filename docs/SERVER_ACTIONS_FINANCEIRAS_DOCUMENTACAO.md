# üìã DOCUMENTA√á√ÉO DAS SERVER ACTIONS FINANCEIRAS

## üìã Vis√£o Geral

Este documento descreve todas as Server Actions implementadas para o m√≥dulo financeiro do sistema Trato de Barbados, incluindo par√¢metros, retornos e funcionalidades.

---

## üèóÔ∏è Estrutura das Server Actions

### **Padr√£o de Implementa√ß√£o**

Todas as Server Actions seguem o padr√£o estabelecido:

- **Retorno**: `ActionResult<T>` para consist√™ncia
- **Valida√ß√£o**: Schemas Zod para valida√ß√£o de entrada
- **Tratamento de Erros**: Blocos try/catch robustos
- **Auditoria**: Logs autom√°ticos de todas as opera√ß√µes
- **Cache**: Revalida√ß√£o autom√°tica das p√°ginas relevantes

---

## üìä Server Actions de Relat√≥rios Financeiros

### **1. `getDREData` - Gera√ß√£o de DRE**

**Arquivo**: `app/actions/reports.ts`

**Objetivo**: Busca e processa dados do DRE (Demonstrativo de Resultado do Exerc√≠cio) para um per√≠odo espec√≠fico.

**Par√¢metros**:

```typescript
{
  period: {
    from: string;    // Data de in√≠cio (YYYY-MM-DD)
    to: string;      // Data de fim (YYYY-MM-DD)
  };
  unidade_id?: string;           // ID da unidade (opcional, padr√£o: 'trato')
  include_audit_trail?: boolean; // Incluir trilha de auditoria (opcional)
}
```

**Funcionalidades**:

- ‚úÖ Valida√ß√£o de entrada com Zod
- ‚úÖ Autentica√ß√£o de usu√°rio
- ‚úÖ Chamada da fun√ß√£o SQL `calculate_dre`
- ‚úÖ Processamento e formata√ß√£o dos dados
- ‚úÖ C√°lculo de margens e indicadores
- ‚úÖ Log de auditoria autom√°tico
- ‚úÖ Revalida√ß√£o de cache

**Retorno**:

```typescript
ActionResult<DREData> = {
  success: true;
  data: {
    periodo: { data_inicio: string; data_fim: string; unidade_id: string };
    receitas: { receita_bruta: number; receita_liquida: number; deducoes: number };
    custos: { custos_servicos: number; outros_custos: number };
    despesas: { despesas_operacionais: number; despesas_financeiras: number };
    resultado: { lucro_bruto: number; lucro_operacional: number; lucro_liquido: number };
    margens: { margem_bruta: number; margem_operacional: number; margem_liquida: number };
    audit_trail?: DREAuditDetail[];
  };
}
```

**Exemplo de Uso**:

```typescript
import { getDREData } from "@/app/actions/reports";

const dreResult = await getDREData({
  period: { from: "2024-01-01", to: "2024-01-31" },
  unidade_id: "trato",
  include_audit_trail: true,
});

if (dreResult.success) {
  console.log("Receita L√≠quida:", dreResult.data.receitas.receita_liquida);
  console.log("Lucro L√≠quido:", dreResult.data.resultado.lucro_liquido);
}
```

---

### **2. `getDREComparison` - Compara√ß√£o de Per√≠odos**

**Objetivo**: Compara DRE de dois per√≠odos diferentes, calculando varia√ß√µes absolutas e percentuais.

**Par√¢metros**:

```typescript
{
  current: Period;   // Per√≠odo atual
  previous: Period;  // Per√≠odo anterior
  unidade_id?: string;
}
```

**Funcionalidades**:

- ‚úÖ Compara√ß√£o de todos os indicadores financeiros
- ‚úÖ C√°lculo de varia√ß√µes absolutas e percentuais
- ‚úÖ Identifica√ß√£o de tend√™ncias de crescimento
- ‚úÖ An√°lise de sazonalidade

**Retorno**:

```typescript
ActionResult<DREComparison> = {
  success: true;
  data: {
    current_period: DREData;
    previous_period: DREData;
    variations: {
      receitas: { absolute: number; percentage: number };
      custos: { absolute: number; percentage: number };
      despesas: { absolute: number; percentage: number };
      resultado: { absolute: number; percentage: number };
    };
    trends: { growth: boolean; strength: 'weak' | 'moderate' | 'strong' };
  };
}
```

---

### **3. `exportDREReport` - Exporta√ß√£o de Relat√≥rios**

**Objetivo**: Exporta dados do DRE em formatos JSON ou CSV para an√°lise externa.

**Par√¢metros**:

```typescript
{
  period: Period;
  format: 'json' | 'csv';
  unidade_id?: string;
}
```

**Funcionalidades**:

- ‚úÖ Exporta√ß√£o em formato JSON estruturado
- ‚úÖ Exporta√ß√£o em formato CSV com headers
- ‚úÖ Nomes de arquivo com conven√ß√£o de per√≠odo
- ‚úÖ Valida√ß√£o de formato de sa√≠da

**Retorno**:

```typescript
ActionResult<{ content: string; filename: string; format: string }>;
```

---

### **4. `getFinancialSummary` - Resumo Financeiro**

**Objetivo**: Retorna resumo financeiro r√°pido com indicadores de crescimento.

**Par√¢metros**:

```typescript
{
  period: Period;
  unidade_id?: string;
}
```

**Funcionalidades**:

- ‚úÖ Resumo consolidado de receitas e despesas
- ‚úÖ Compara√ß√£o com per√≠odo anterior
- ‚úÖ Indicadores de crescimento percentual
- ‚úÖ M√©tricas de lucratividade

---

### **5. `getCashFlow` - An√°lise de Fluxo de Caixa**

**Objetivo**: Analisa entradas e sa√≠das de caixa ao longo do per√≠odo.

**Par√¢metros**:

```typescript
{
  period: Period;
  unidade_id?: string;
  group_by: 'day' | 'week' | 'month';
}
```

**Funcionalidades**:

- ‚úÖ Agrupamento por dia, semana ou m√™s
- ‚úÖ An√°lise de sazonalidade
- ‚úÖ Identifica√ß√£o de padr√µes de fluxo
- ‚úÖ Proje√ß√µes baseadas em hist√≥rico

---

### **6. `getProfitabilityAnalysis` - An√°lise de Lucratividade**

**Objetivo**: Calcula m√©tricas chave de lucratividade e efici√™ncia operacional.

**Par√¢metros**:

```typescript
{
  period: Period;
  unidade_id?: string;
}
```

**Funcionalidades**:

- ‚úÖ Margens de lucratividade
- ‚úÖ Indicadores de efici√™ncia operacional
- ‚úÖ An√°lise de custos por servi√ßo
- ‚úÖ Benchmarking com per√≠odos anteriores

---

## üîç Server Actions de Valida√ß√£o e Auditoria

### **7. `validateFinancialData` - Valida√ß√£o Completa**

**Objetivo**: Executa valida√ß√£o completa de dados financeiros com 6 tipos de verifica√ß√£o.

**Par√¢metros**:

```typescript
{
  period: Period;
  unidade_id?: string;
  include_detailed_audit?: boolean;
}
```

**Tipos de Valida√ß√£o**:

1. **Integridade Referencial** - Verifica relacionamentos entre tabelas
2. **Balanceamento Cont√°bil** - Valida d√©bitos = cr√©ditos
3. **Consist√™ncia de Valores** - Detecta valores an√¥malos
4. **Consist√™ncia de Datas** - Valida per√≠odos e sequ√™ncias
5. **Detec√ß√£o de Anomalias** - Identifica padr√µes suspeitos
6. **Completude dos Dados** - Verifica dados obrigat√≥rios

**Retorno**:

```typescript
ActionResult<DataValidationResult> = {
  success: true;
  data: {
    isValid: boolean;
    errors: ValidationError[];
    warnings: ValidationWarning[];
    summary: {
      total_checks: number;
      passed_checks: number;
      failed_checks: number;
      warning_checks: number;
    };
    data_quality_score: number;
  };
}
```

---

### **8. `generateAuditReport` - Relat√≥rio de Auditoria**

**Objetivo**: Gera relat√≥rio completo de auditoria com todas as valida√ß√µes e an√°lises.

**Par√¢metros**:

```typescript
{
  period: Period;
  unidade_id?: string;
}
```

**Funcionalidades**:

- ‚úÖ Execu√ß√£o de todas as valida√ß√µes
- ‚úÖ C√°lculo de scores de qualidade
- ‚úÖ Reconcilia√ß√£o cont√°bil
- ‚úÖ Detec√ß√£o de lan√ßamentos suspeitos
- ‚úÖ Relat√≥rio consolidado em formato estruturado

---

## üí∞ Server Actions de Processamento Financeiro

### **9. `processAutomaticRevenue` - Processamento de Receitas**

**Arquivo**: `app/actions/financial.ts`

**Objetivo**: Processa receita autom√°tica a partir de webhook de pagamento ASAAS.

**Par√¢metros**:

```typescript
PaymentWebhookData = {
  event: string;
  payment: {
    id: string;
    customer: string;
    value: number;        // Em centavos
    description: string;
    billingType: string;
    // ... outros campos
  };
  timestamp: string;
  webhookId: string;
}
```

**Funcionalidades**:

- ‚úÖ Verifica√ß√£o de duplicatas
- ‚úÖ Busca de contas cont√°beis padr√£o
- ‚úÖ Cria√ß√£o de lan√ßamento cont√°bil
- ‚úÖ Registro de receita autom√°tica
- ‚úÖ Log de auditoria completo
- ‚úÖ Revalida√ß√£o de cache

**Retorno**:

```typescript
ActionResult<AutomaticRevenueResult> = {
  success: true;
  data: {
    id: string;
    payment_id: string;
    customer_id: string;
    value: number;
    description: string;
    lancamento_id: string;
    created_at: string;
  };
}
```

---

### **10. `getAutomaticRevenues` - Busca de Receitas**

**Objetivo**: Busca receitas autom√°ticas processadas com filtros e pagina√ß√£o.

**Par√¢metros**:

```typescript
{
  filters: {
    payment_id?: string;
    customer_id?: string;
    status?: string;
    date_from?: string;
    date_to?: string;
    unidade_id?: string;
  };
  page: number;
  limit: number;
}
```

**Funcionalidades**:

- ‚úÖ Filtros m√∫ltiplos
- ‚úÖ Pagina√ß√£o configur√°vel
- ‚úÖ Ordena√ß√£o por data
- ‚úÖ Contagem total de registros

---

### **11. `recalculateAutomaticRevenues` - Reprocessamento**

**Objetivo**: Reprocessa lote de receitas autom√°ticas para corre√ß√µes.

**Par√¢metros**:

```typescript
{
  filters: {
    payment_id?: string;
    customer_id?: string;
    status?: string;
    date_from?: string;
    date_to?: string;
  };
}
```

**Funcionalidades**:

- ‚úÖ Reprocessamento em lote
- ‚úÖ Controle de erros individual
- ‚úÖ Atualiza√ß√£o de status
- ‚úÖ Log de auditoria de reprocessamento

---

### **12. `getAutomaticRevenueStats` - Estat√≠sticas**

**Objetivo**: Obt√©m estat√≠sticas das receitas autom√°ticas processadas.

**Par√¢metros**:

```typescript
{
  unidade_id: string;
}
```

**Funcionalidades**:

- ‚úÖ Contagem por status
- ‚úÖ Totais por per√≠odo
- ‚úÖ M√©tricas de processamento
- ‚úÖ An√°lise de performance

---

## üîß Server Actions de Utilit√°rios

### **13. `validateReferentialIntegrity` - Valida√ß√£o Referencial**

**Fun√ß√£o Interna**: Valida integridade referencial entre tabelas financeiras.

**Verifica√ß√µes**:

- ‚úÖ Lan√ßamentos cont√°beis ‚Üí Contas cont√°beis
- ‚úÖ Receitas autom√°ticas ‚Üí Lan√ßamentos cont√°beis
- ‚úÖ Centros de custo ‚Üí Unidades
- ‚úÖ Clientes ‚Üí Unidades

---

### **14. `validateAccountingBalance` - Balanceamento Cont√°bil**

**Fun√ß√£o Interna**: Verifica se d√©bitos = cr√©ditos em todos os per√≠odos.

**Valida√ß√µes**:

- ‚úÖ Soma de d√©bitos = soma de cr√©ditos
- ‚úÖ Toler√¢ncia de 1 centavo
- ‚úÖ Verifica√ß√£o por per√≠odo
- ‚úÖ Identifica√ß√£o de desbalanceamentos

---

### **15. `detectAnomalies` - Detec√ß√£o de Anomalias**

**Fun√ß√£o Interna**: Identifica padr√µes suspeitos nos dados financeiros.

**Detec√ß√µes**:

- ‚úÖ Valores extremamente altos/baixos
- ‚úÖ Padr√µes de transa√ß√µes suspeitas
- ‚úÖ Inconsist√™ncias de datas
- ‚úÖ Valores negativos inesperados

---

## üìä Schemas de Valida√ß√£o Zod

### **Schemas Principais**

```typescript
// Per√≠odo
const periodSchema = z.object({
  from: z
    .string()
    .refine((val) => !isNaN(Date.parse(val)), "Data de in√≠cio inv√°lida"),
  to: z
    .string()
    .refine((val) => !isNaN(Date.parse(val)), "Data de fim inv√°lida"),
});

// Requisi√ß√£o DRE
const dreRequestSchema = z.object({
  period: periodSchema,
  unidade_id: z.string().min(1, "ID da unidade √© obrigat√≥rio").optional(),
  include_audit_trail: z.boolean().default(false),
});

// Compara√ß√£o DRE
const dreComparisonSchema = z.object({
  current: periodSchema,
  previous: periodSchema,
  unidade_id: z.string().min(1, "ID da unidade √© obrigat√≥rio").optional(),
});
```

---

## üöÄ Como Usar as Server Actions

### **1. Importa√ß√£o**

```typescript
import {
  getDREData,
  getDREComparison,
  processAutomaticRevenue,
} from "@/app/actions/reports";
import { getAutomaticRevenues } from "@/app/actions/financial";
```

### **2. Exemplo de Uso Completo**

```typescript
// Gerar DRE mensal
const dreResult = await getDREData({
  period: { from: "2024-01-01", to: "2024-01-31" },
  unidade_id: "trato",
  include_audit_trail: true,
});

if (dreResult.success) {
  const dre = dreResult.data;

  // Usar dados do DRE
  console.log(`Receita L√≠quida: R$ ${dre.receitas.receita_liquida}`);
  console.log(`Lucro L√≠quido: R$ ${dre.resultado.lucro_liquido}`);
  console.log(`Margem L√≠quida: ${dre.margens.margem_liquida}%`);

  // Exportar relat√≥rio
  const exportResult = await exportDREReport({
    period: { from: "2024-01-01", to: "2024-01-31" },
    format: "csv",
  });
}
```

### **3. Valida√ß√£o de Dados**

```typescript
// Validar dados financeiros
const validationResult = await validateFinancialData({
  period: { from: "2024-01-01", to: "2024-01-31" },
  unidade_id: "trato",
  include_detailed_audit: true,
});

if (validationResult.success) {
  const validation = validationResult.data;

  if (validation.isValid) {
    console.log(`‚úÖ Dados v√°lidos - Score: ${validation.data_quality_score}%`);
  } else {
    console.log(`‚ùå ${validation.errors.length} erros encontrados`);
    validation.errors.forEach((error) => {
      console.log(`  - ${error.message} (${error.severity})`);
    });
  }
}
```

---

## üîí Seguran√ßa e Auditoria

### **Autentica√ß√£o**

- ‚úÖ Todas as Server Actions verificam autentica√ß√£o
- ‚úÖ Verifica√ß√£o de permiss√µes por unidade
- ‚úÖ Controle de acesso baseado em roles

### **Valida√ß√£o de Entrada**

- ‚úÖ Schemas Zod para valida√ß√£o robusta
- ‚úÖ Sanitiza√ß√£o de dados de entrada
- ‚úÖ Preven√ß√£o de SQL injection
- ‚úÖ Valida√ß√£o de tipos TypeScript

### **Logs de Auditoria**

- ‚úÖ Todas as opera√ß√µes s√£o registradas
- ‚úÖ Contexto completo (usu√°rio, timestamp, dados)
- ‚úÖ Rastreabilidade de mudan√ßas
- ‚úÖ Compliance e debugging

---

## üìà Performance e Otimiza√ß√£o

### **√çndices de Banco**

- ‚úÖ 11 √≠ndices cr√≠ticos implementados
- ‚úÖ Otimiza√ß√£o para consultas DRE
- ‚úÖ Cache materializado para relat√≥rios frequentes
- ‚úÖ Monitoramento autom√°tico de performance

### **Processamento Ass√≠ncrono**

- ‚úÖ Webhook ASAAS ‚Üí Fila BullMQ ‚Üí Worker
- ‚úÖ Processamento paralelo de valida√ß√µes
- ‚úÖ Retry autom√°tico com backoff exponencial
- ‚úÖ Concorr√™ncia configur√°vel

---

## üéØ Status de Implementa√ß√£o

### **‚úÖ Conclu√≠do**

- Todas as Server Actions principais implementadas
- Sistema de valida√ß√£o robusto
- Auditoria completa
- Otimiza√ß√µes de performance
- Testes abrangentes

### **üöÄ Pronto para Deploy**

- C√≥digo validado e testado
- Documenta√ß√£o completa
- Configura√ß√µes de ambiente
- Scripts de migra√ß√£o
- Monitoramento implementado

---

**üìã Esta documenta√ß√£o garante que todas as Server Actions financeiras estejam prontas para deploy em produ√ß√£o, com funcionalidades robustas, valida√ß√£o completa e auditoria integrada.**

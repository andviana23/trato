# üìä Documenta√ß√£o Completa das Tabelas do Supabase - Trato de Barbados

## üéØ Vis√£o Geral

Este documento mapeia todas as tabelas e views do banco de dados Supabase utilizadas pelo sistema Trato de Barbados, incluindo sua estrutura, relacionamentos e como s√£o utilizadas no sistema.

---

## üèóÔ∏è Estrutura das Tabelas

### 1. **Tabelas de Autentica√ß√£o e Usu√°rios**

#### `profiles`

**Prop√≥sito**: Perfis de usu√°rios do sistema
**Relacionamentos**: Referencia `auth.users` (Supabase Auth)

```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT,
  first_name TEXT,
  last_name TEXT,
  full_name TEXT,
  role TEXT CHECK (role IN ('barbershop_owner', 'professional', 'client', 'admin', 'recepcionista')),
  phone TEXT,
  avatar_url TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Autentica√ß√£o e autoriza√ß√£o
- Controle de acesso por roles
- Perfis de usu√°rios (clientes, barbeiros, propriet√°rios)

---

#### `user_roles`

**Prop√≥sito**: Defini√ß√£o de roles e permiss√µes
**Relacionamentos**: Referenciada por `profiles.role`

```sql
-- Enum de roles dispon√≠veis
CREATE TYPE user_role AS ENUM (
  'admin',
  'barbershop_owner',
  'professional',
  'recepcionista',
  'client'
);
```

---

### 2. **Tabelas de Estrutura Organizacional**

#### `unidades`

**Prop√≥sito**: Unidades f√≠sicas (barbearias)
**Relacionamentos**: Referenciada por m√∫ltiplas tabelas

```sql
CREATE TABLE unidades (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  endereco TEXT,
  telefone TEXT,
  email TEXT,
  horario_funcionamento JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Separa√ß√£o de dados por unidade (Trato vs BarberBeer)
- Controle de acesso por unidade
- Relat√≥rios separados por unidade

---

#### `barbershops`

**Prop√≥sito**: Informa√ß√µes das barbearias
**Relacionamentos**: Referenciada por `professionals`

```sql
CREATE TABLE barbershops (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  address TEXT,
  phone TEXT,
  email TEXT,
  business_hours JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### 3. **Tabelas de Profissionais**

#### `professionals`

**Prop√≥sito**: Barbeiros e profissionais
**Relacionamentos**: Referencia `profiles`, `barbershops`

```sql
CREATE TABLE professionals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  barbershop_id UUID REFERENCES barbershops(id),
  user_id UUID REFERENCES profiles(id),
  name VARCHAR(200) NOT NULL,
  email VARCHAR(255),
  phone VARCHAR(20),
  specialty TEXT,
  bio TEXT,
  avatar_url TEXT,
  hourly_rate DECIMAL(10,2),
  commission_rate DECIMAL(5,2) DEFAULT 50.00,
  is_active BOOLEAN DEFAULT true,
  can_receive_appointments BOOLEAN DEFAULT true,
  work_schedule JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Lista de barbeiros dispon√≠veis
- C√°lculo de comiss√µes
- Agendamentos por profissional
- Fila de atendimento

---

#### `profissionais`

**Prop√≥sito**: Tabela alternativa para profissionais (legacy)
**Relacionamentos**: Similar a `professionals`

---

### 4. **Tabelas de Clientes**

#### `clients`

**Prop√≥sito**: Clientes da barbearia
**Relacionamentos**: Referenciada por agendamentos e vendas

```sql
CREATE TABLE clients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  email TEXT,
  phone TEXT,
  birth_date DATE,
  preferences JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Cadastro de clientes
- Hist√≥rico de atendimentos
- Prefer√™ncias e observa√ß√µes

---

#### `clientes`

**Prop√≥sito**: Tabela alternativa para clientes (legacy)
**Relacionamentos**: Similar a `clients`

---

### 5. **Tabelas de Servi√ßos**

#### `servicos`

**Prop√≥sito**: Cat√°logo de servi√ßos oferecidos
**Relacionamentos**: Referenciada por agendamentos

```sql
CREATE TABLE servicos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  descricao TEXT,
  duracao_minutos INTEGER DEFAULT 30,
  preco DECIMAL(10,2) NOT NULL,
  categoria_id UUID REFERENCES categorias(id),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Agendamentos com dura√ß√£o e pre√ßo
- C√°lculo de tempo de atendimento
- Categoriza√ß√£o de servi√ßos

---

#### `servicos_avulsos`

**Prop√≥sito**: Servi√ßos pontuais realizados
**Relacionamentos**: Referencia `professionals`, `clients`

```sql
CREATE TABLE servicos_avulsos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profissional_id UUID REFERENCES professionals(id),
  cliente_id UUID REFERENCES clients(id),
  servico_id UUID REFERENCES servicos(id),
  data_realizacao DATE NOT NULL,
  valor DECIMAL(10,2) NOT NULL, 
  comissao DECIMAL(10,2),
  observacoes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Registro de servi√ßos realizados
- C√°lculo de comiss√µes
- Hist√≥rico de atendimentos

---

#### `servicos_realizados`

**Prop√≥sito**: Hist√≥rico detalhado de servi√ßos
**Relacionamentos**: Similar a `servicos_avulsos`

---

### 6. **Tabelas de Agendamentos**

#### `appointments`

**Prop√≥sito**: Agendamentos principais do sistema
**Relacionamentos**: Referencia `professionals`, `clients`, `unidades`

```sql
CREATE TABLE appointments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cliente_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  barbeiro_id UUID REFERENCES public.professionals(id) ON DELETE SET NULL,
  unidade_id UUID NOT NULL,
  start_at TIMESTAMPTZ NOT NULL,
  end_at TIMESTAMPTZ NOT NULL,
  status TEXT NOT NULL DEFAULT 'agendado' CHECK (
    status IN ('agendado', 'confirmado', 'atendido', 'cancelado', 'no_show', 'bloqueado')
  ),
  servicos JSONB DEFAULT '[]'::jsonb,
  observacoes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Sistema principal de agendamentos
- Controle de status
- Integra√ß√£o com notifica√ß√µes
- Separa√ß√£o por unidade

---

#### `agendamentos`

**Prop√≥sito**: Tabela alternativa para agendamentos (legacy)
**Relacionamentos**: Similar a `appointments`

---

#### `agendamentos_barberbeer`

**Prop√≥sito**: Agendamentos espec√≠ficos da unidade BarberBeer
**Relacionamentos**: Referencia `unidades`

---

#### `agendamentos_trato`

**Prop√≥sito**: Agendamentos espec√≠ficos da unidade Trato
**Relacionamentos**: Referencia `unidades`

---

### 7. **Tabelas de Fila de Atendimento**

#### `barber_queue`

**Prop√≥sito**: Fila inteligente de barbeiros
**Relacionamentos**: Referencia `professionals`

```sql
CREATE TABLE barber_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profissional_id UUID REFERENCES professionals(id),
  queue_position INTEGER NOT NULL,
  daily_services INTEGER DEFAULT 0,
  total_services INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  last_service_date DATE,
  passou_vez INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Fila inteligente com reorganiza√ß√£o autom√°tica
- Controle de atendimentos por barbeiro
- Sistema de "fila indiana" (quem atende mais vai para o final)

---

#### `queue`

**Prop√≥sito**: Fila de clientes aguardando
**Relacionamentos**: Referencia `clients`, `professionals`

---

### 8. **Tabelas de Produtos**

#### `produtos_trato_de_barbados`

**Prop√≥sito**: Produtos da unidade Trato
**Relacionamentos**: Referencia `categorias`, `unidades`

```sql
CREATE TABLE produtos_trato_de_barbados (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  descricao TEXT,
  preco DECIMAL(10,2) NOT NULL,
  categoria_id UUID REFERENCES categorias(id),
  estoque_atual INTEGER DEFAULT 0,
  estoque_minimo INTEGER DEFAULT 5,
  unidade_id UUID REFERENCES unidades(id),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Controle de estoque
- Vendas de produtos
- Metas de vendas por barbeiro

---

#### `produtos_barberbeer`

**Prop√≥sito**: Produtos da unidade BarberBeer
**Relacionamentos**: Similar a `produtos_trato_de_barbados`

---

#### `categorias`

**Prop√≥sito**: Categorias de produtos
**Relacionamentos**: Referenciada por produtos

---

#### `categories`

**Prop√≥sito**: Tabela alternativa para categorias (legacy)

---

#### `marcas`

**Prop√≥sito**: Marcas dos produtos
**Relacionamentos**: Referenciada por produtos

---

### 9. **Tabelas de Vendas**

#### `vendas_produtos`

**Prop√≥sito**: Registro de vendas de produtos
**Relacionamentos**: Referencia produtos, profissionais, clientes

```sql
CREATE TABLE vendas_produtos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  produto_id UUID NOT NULL,
  profissional_id UUID REFERENCES professionals(id),
  cliente_id UUID REFERENCES clients(id),
  quantidade INTEGER NOT NULL,
  preco_unitario DECIMAL(10,2) NOT NULL,
  preco_total DECIMAL(10,2) NOT NULL,
  data_venda DATE NOT NULL,
  comissao DECIMAL(10,2),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Controle de vendas
- C√°lculo de comiss√µes
- Metas de vendas

---

#### `vendas_produtos_barbeiro`

**Prop√≥sito**: Vendas espec√≠ficas por barbeiro
**Relacionamentos**: Similar a `vendas_produtos`

---

### 10. **Tabelas de Assinaturas**

#### `subscriptions`

**Prop√≥sito**: Assinaturas mensais
**Relacionamentos**: Referencia `clients`, `planos`

```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cliente_id UUID REFERENCES clients(id),
  plano_id UUID REFERENCES planos(id),
  status TEXT NOT NULL DEFAULT 'ativa',
  data_inicio DATE NOT NULL,
  data_fim DATE,
  valor_mensal DECIMAL(10,2) NOT NULL,
  forma_pagamento TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Controle de assinaturas mensais
- Integra√ß√£o com ASAAS
- Faturamento recorrente

---

#### `assinaturas`

**Prop√≥sito**: Tabela alternativa para assinaturas (legacy)

---

#### `planos`

**Prop√≥sito**: Planos de assinatura dispon√≠veis
**Relacionamentos**: Referenciada por assinaturas

---

#### `plans`

**Prop√≥sito**: Tabela alternativa para planos (legacy)

---

#### `plan_categories`

**Prop√≥sito**: Categorias de planos
**Relacionamentos**: Referenciada por planos

---

### 11. **Tabelas de Pagamentos**

#### `payments`

**Prop√≥sito**: Pagamentos gerais
**Relacionamentos**: Referencia m√∫ltiplas entidades

---

#### `pagamentos_eseas`

**Prop√≥sito**: Pagamentos espec√≠ficos (legacy)

---

#### `external_payments`

**Prop√≥sito**: Pagamentos externos
**Relacionamentos**: Referencia m√∫ltiplas entidades

---

### 12. **Tabelas de Metas**

#### `metas_barberbeer`

**Prop√≥sito**: Metas dos barbeiros da BarberBeer
**Relacionamentos**: Referencia `professionals`, `unidades`

```sql
CREATE TABLE metas_barberbeer (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  barbeiro_id UUID REFERENCES professionals(id),
  mes INTEGER NOT NULL CHECK (mes >= 1 AND mes <= 12),
  ano INTEGER NOT NULL,
  meta_venda_produto DECIMAL(10,2) DEFAULT 0,
  meta_faturamento DECIMAL(10,2) DEFAULT 0,
  tipo_bonificacao TEXT CHECK (tipo_bonificacao IN ('fixo', 'percentual')),
  valor_bonificacao DECIMAL(10,2) DEFAULT 0,
  foi_batida BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- Metas mensais por barbeiro
- C√°lculo de bonifica√ß√µes
- Performance tracking

---

#### `metas_trato_faixas`

**Prop√≥sito**: Faixas de metas para Trato
**Relacionamentos**: Referencia `unidades`

---

#### `metas_barberbeer_faixas`

**Prop√≥sito**: Faixas de metas para BarberBeer
**Relacionamentos**: Referencia `unidades`

---

#### `monthly_goals`

**Prop√≥sito**: Metas mensais gerais
**Relacionamentos**: Referencia `unidades`

---

#### `monthly_revenue`

**Prop√≥sito**: Receita mensal por unidade
**Relacionamentos**: Referencia `unidades`

---

### 13. **Tabelas de Comiss√µes**

#### `comissoes_avulses`

**Prop√≥sito**: Comiss√µes de servi√ßos avulsos
**Relacionamentos**: Referencia `professionals`, `servicos_avulsos`

```sql
CREATE TABLE comissoes_avulses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profissional_id UUID REFERENCES professionals(id),
  servico_avulso_id UUID REFERENCES servicos_avulsos(id),
  valor_comissao DECIMAL(10,2) NOT NULL,
  valor_comissao DECIMAL(10,2) NOT NULL,
  percentual_comissao DECIMAL(5,2) NOT NULL,
  mes INTEGER NOT NULL,
  ano INTEGER NOT NULL,
  pago BOOLEAN DEFAULT false,
  data_pagamento DATE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Uso no Sistema**:

- C√°lculo de comiss√µes mensais
- Controle de pagamentos
- Relat√≥rios financeiros

---

### 14. **Tabelas de Faturamento**

#### `faturamento_assinatura`

**Prop√≥sito**: Faturamento de assinaturas
**Relacionamentos**: Referencia `assinaturas`, `unidades`

---

#### `faturamento_assinatura_unidades`

**Prop√≥sito**: Faturamento por unidade
**Relacionamentos**: Referencia `unidades`

---

#### `receitas`

**Prop√≥sito**: Receitas gerais
**Relacionamentos**: Referencia m√∫ltiplas entidades

---

#### `despesas`

**Prop√≥sito**: Despesas gerais
**Relacionamentos**: Referencia m√∫ltiplas entidades

---

### 15. **Tabelas de Notifica√ß√µes**

#### `notifications`

**Prop√≥sito**: Sistema de notifica√ß√µes
**Relacionamentos**: Referencia m√∫ltiplas entidades

---

### 16. **Tabelas de Bloqueios**

#### `bloqueios_trato`

**Prop√≥sito**: Hor√°rios bloqueados da unidade Trato
**Relacionamentos**: Referencia `unidades`

---

#### `bloqueios_barberbeer`

**Prop√≥sito**: Hor√°rios bloqueados da unidade BarberBeer
**Relacionamentos**: Referencia `unidades`

---

### 17. **Views do Sistema**

#### `vw_atendimentos_por_cliente`

**Prop√≥sito**: View de atendimentos agregados por cliente
**Uso**: Relat√≥rios de clientes

#### `vw_clientes_resumo`

**Prop√≥sito**: Resumo de informa√ß√µes dos clientes
**Uso**: Dashboard e relat√≥rios

#### `vw_pagamentos_por_cliente`

**Prop√≥sito**: View de pagamentos por cliente
**Uso**: Relat√≥rios financeiros

#### `vw_pendencias_por_cliente`

**Prop√≥sito**: View de pend√™ncias por cliente
**Uso**: Controle de inadimpl√™ncia

---

## üîó Relacionamentos Principais

### Hierarquia de Unidades

```
unidades
‚îú‚îÄ‚îÄ professionals (barbeiros)
‚îú‚îÄ‚îÄ appointments (agendamentos)
‚îú‚îÄ‚îÄ produtos_*
‚îú‚îÄ‚îÄ metas_*
‚îî‚îÄ‚îÄ vendas_*
```

### Fluxo de Agendamentos

```
clients ‚Üí appointments ‚Üí professionals
    ‚Üì
servicos ‚Üí servicos_avulsos ‚Üí comissoes_avulses
```

### Sistema de Metas

```
professionals ‚Üí metas_* ‚Üí vendas_produtos
    ‚Üì
monthly_goals ‚Üí monthly_revenue
```

---

## üìä Padr√µes de Uso

### 1. **Separa√ß√£o por Unidade**

- Todas as tabelas principais t√™m refer√™ncia a `unidade_id`
- RLS (Row Level Security) implementado por unidade
- Fun√ß√£o `current_unidade()` para isolamento de dados

### 2. **Controle de Status**

- Padr√£o: `is_active` para soft delete
- Status espec√≠ficos para agendamentos e assinaturas
- Hist√≥rico de mudan√ßas com `created_at` e `updated_at`

### 3. **Sistema de Comiss√µes**

- Padr√£o de 40% sobre faturamento
- Separa√ß√£o entre comiss√µes de assinaturas e avulsas
- Metas mensais com bonifica√ß√µes

### 4. **Controle de Estoque**

- `estoque_atual` e `estoque_minimo`
- Alertas autom√°ticos de estoque baixo
- Rastreamento de vendas por produto

---

## üöÄ Pr√≥ximos Passos

### 1. **Consolida√ß√£o de Tabelas**

- Unificar tabelas duplicadas (ex: `clients` vs `clientes`)
- Padronizar nomenclatura em ingl√™s
- Migrar dados legados para novas estruturas

### 2. **Implementa√ß√£o de RLS**

- Aplicar RLS em todas as tabelas
- Testar isolamento por unidade
- Configurar pol√≠ticas de acesso por role

### 3. **Otimiza√ß√£o de Performance**

- Revisar √≠ndices existentes
- Implementar materialized views para relat√≥rios
- Otimizar queries complexas

### 4. **Backup e Migra√ß√£o**

- Scripts de migra√ß√£o para produ√ß√£o
- Backup autom√°tico das tabelas cr√≠ticas
- Versionamento de schema

---

## üìù Notas de Manuten√ß√£o

### Vari√°veis de Ambiente Necess√°rias

```env
NEXT_PUBLIC_SUPABASE_URL=sua_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=sua_chave
SUPABASE_SERVICE_ROLE_KEY=sua_chave_service
```

### Comandos √öteis

```bash
# Verificar estrutura das tabelas
\d+ nome_da_tabela

# Verificar pol√≠ticas RLS
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE schemaname = 'public';

# Verificar relacionamentos
SELECT
  tc.table_name,
  kcu.column_name,
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE constraint_type = 'FOREIGN KEY';
```

---

**Vers√£o**: 1.0  
**√öltima atualiza√ß√£o**: Dezembro 2024  
**Respons√°vel**: Documenta√ß√£o do Sistema
